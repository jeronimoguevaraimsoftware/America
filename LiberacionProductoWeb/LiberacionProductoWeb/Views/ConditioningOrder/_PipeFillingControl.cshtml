@using Microsoft.AspNetCore.Identity;
@using Microsoft.AspNetCore.Mvc.Localization
@using LiberacionProductoWeb.Helpers;
@using LiberacionProductoWeb.Localize;
@using Microsoft.Extensions.Localization;
@using Microsoft.Extensions.Configuration;
@using System.Globalization;
@model LiberacionProductoWeb.Models.ConditioningOrderViewModels.ConditioningOrderViewModel;
@inject IViewLocalizer Localizer
@inject UserManager<LiberacionProductoWeb.Models.IndentityModels.ApplicationUser> UserManager
@inject IStringLocalizer<Resource> resource;
@inject IConfiguration Config;
@{
    var claimsIdentity = User.Identity as System.Security.Claims.ClaimsIdentity;
    var userFirstName = "";
    var name = claimsIdentity.Name;
    var rolesUsr = "";
    if (name != null)
    {
        var FullName = UserManager.FindByNameAsync(name);
        userFirstName = FullName.Result.NombreUsuario;
        rolesUsr = FullName.Result.Rol;

    }
}
<div id="pipeFilling-container">
    <ul class="nav nav-tabs">
        @{
            int tourNumberIndex = 0;
        }
        @foreach (var item in Model.PipeFillingControl)
        {
            <li>
                <a data-toggle="tab" id="pipeFilling-tourNumber-tab-@tourNumberIndex"
               href="#pipeFilling-tourNumber-tabs-@tourNumberIndex" style="color: #007ab9;">
                    Tour number @item.TourNumber
                </a>
                <input asp-for="@item.TourNumber" id="PipeFillingTourNumber-@tourNumberIndex" hidden />
            </li>
            tourNumberIndex++;
        }
    </ul>

    <div class="tab-content">
        @{
            tourNumberIndex = 0;
        }
        @foreach (var item in Model.PipeFillingControl)
        {
            <div class="tab-pane fade" id="pipeFilling-tourNumber-tabs-@tourNumberIndex" data-type="tournumber" data-index="@tourNumberIndex">
                <div>
                    <ul class="nav nav-tabs">
                        @{
                            int pipeIndex = 0;
                        }
                        @foreach (var pipeItem in item.PipesList)
                        {
                            <li>
                                <a data-toggle="tab" id="pipeFilling-pipe-tab-@tourNumberIndex-@pipeIndex"
                           href="#pipeFilling-pipe-tabs-@tourNumberIndex-@pipeIndex" style="color: #007ab9;">
                                    @pipeItem.PipeNumber
                                </a>
                            </li>
                            pipeIndex++;
                        }
                    </ul>
                    <div class="tab-content">
                        @{
                            pipeIndex = 0;
                        }
                        @foreach (var pipeItem in item.PipesList)
                        {
                            <div class="tab-pane fade" id="pipeFilling-pipe-tabs-@tourNumberIndex-@pipeIndex" data-type="pipe" data-index="@pipeIndex">
                                <input asp-for="@pipeItem.CheckListId" id="PipeFillingCheckListId-@tourNumberIndex-@pipeIndex" hidden />
                                <input asp-for="@pipeItem.CheckListStatus" id="PipeFillingCheckListStatus-@tourNumberIndex-@pipeIndex" hidden />
                                <p>
                                    Check List de Verificación de Pipa <span style="color: #007ab9;">Estado</span><label id="PipeFillingCheckListStatusLbl-@tourNumberIndex-@pipeIndex">@pipeItem.CheckListStatus</label>
                                    <button class='btn btn btn-inverse' id="btnUpdateCheckList-@tourNumberIndex-@pipeIndex" type="button" style="margin: 20px auto;" onclick="GetLastStatus(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @tourNumberIndex, @pipeIndex, @pipeItem.CheckListId)" id="btnPipeFillingUpdate-@tourNumberIndex-@pipeIndex">
                                        <i class="fa fa-sync"></i>  Actualizar
                                    </button>
                                </p>
                                <div class="row">
                                    <button name="btnPipeFillingWeb" hidden class='btn btn' id="btnPipeFillingWeb-@tourNumberIndex-@pipeIndex" type="button" style="background-color:transparent" onclick="pipeFillingWeb(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @pipeItem.CheckListId, @tourNumberIndex, @pipeIndex)">
                                        <i class="fa fa-desktop">Llenar en Web</i>
                                    </button>
                                    <button name="btnPipeFillingManual" hidden class='btn btn' id="btnPipeFillingManual-@tourNumberIndex-@pipeIndex" type="button" style="background-color:transparent" onclick="pipeFillingManual(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @tourNumberIndex, @pipeIndex)">
                                        <i class="fa fa-edit">Llenar manual</i>
                                    </button>
                                    <span id="checkListManualCtrls-@tourNumberIndex-@pipeIndex" hidden>
                                        <input type="checkbox" id="CheckListIncomplianceCheckTrue-@tourNumberIndex-@pipeIndex"
                                       onclick="saveChecklistManual(@pipeItem.PipeFillingControlId, '@item.TourNumber' , '@pipeItem.PipeNumber', '@pipeItem.CheckListId', '@pipeItem.CheckListStatus', '@pipeItem.DistributionBatch', @tourNumberIndex, @pipeIndex, true)"
                                       form-control-lg disabled />
                                        <label>Cumple</label>
                                        <input type="checkbox" id="CheckListIncomplianceCheckFalse-@tourNumberIndex-@pipeIndex"
                                       onclick="saveChecklistManual(@pipeItem.PipeFillingControlId, '@item.TourNumber' ,'@pipeItem.PipeNumber', '@pipeItem.CheckListId', '@pipeItem.CheckListStatus', '@pipeItem.DistributionBatch', @tourNumberIndex, @pipeIndex, false)"
                                       form-control-lg disabled />
                                        <label>No cumple</label>
                                        <input asp-for="@pipeItem.CheckListIncompliance" id="CheckListIncompliance-@tourNumberIndex-@pipeIndex" hidden />
                                        <input asp-for="@pipeItem.CheckListSource" id="CheckListSource-@tourNumberIndex-@pipeIndex" hidden />
                                        <input asp-for="@pipeItem.CheckListStatus" id="CheckListStatus-@tourNumberIndex-@pipeIndex" hidden />
                                        @*<a onclick="ShowModalFile(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @pipeItem.CheckListId, @tourNumberIndex, @pipeIndex)"><label class="fa fa-cloud-upload">Subir archivo</label></a>*@
                                    </span>
                                    <button hidden name="btnPipeFillingRead" class='btn btn' id="btnPipeFillingRead-@tourNumberIndex-@pipeIndex" type="button" style="background-color:transparent" onclick="pipeFillingRead(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @pipeItem.CheckListId)">
                                        <i class="fa fa-file">Consultar</i>
                                    </button>
                                    <button name="btnPipeFillingShowHistory" class='btn btn' id="btnPipeFillingShowHistory-@tourNumberIndex-@pipeIndex" type="button" style="background-color:transparent" onclick="pipeFillingShowHistory(@Model.Id, '@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', @tourNumberIndex, @pipeIndex)">
                                        <i class="fa fa-history">Ver Historial</i>
                                    </button>
                                </div>

                                <div class="row">
                                    <table id="table-HistoryChecklist-@tourNumberIndex-@pipeIndex" hidden="hidden" class="table table-striped table-bordered" style="width:95%;">
                                        <thead>
                                            <tr>
                                                <th colspan="8">Historial de checklist</th>
                                            </tr>
                                            <tr>
                                                <th scope="col">Elaborado por</th>
                                                <th scope="col">Fecha y hora</th>
                                                <th scope="col">Checklist de Verificación de pipas</th>
                                                <th scope="col">Observaciones</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>

                                <div class="row">
                                    <div class="table-responsive">
                                        <table id="table-5-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered" style="width:100%;">
                                            <thead>
                                                <tr>
                                                    <th colspan="5">
                                                        Tabla 5: Control de llenado de pipas
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Fecha</th>
                                                    <th scope="col">Número de pipa</th>
                                                    <th scope="col">Nivel o peso inicial</th>
                                                    <th scope="col">Nivel o peso Final</th>
                                                    <th scope="col">Cantidad de producto llenado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <input asp-for="@pipeItem.Date" id="PipeFillingDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @(pipeItem.Date.HasValue ? pipeItem.Date.Value.ToString("yyyy-MM-dd") : string.Empty)
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.PipeNumber" id="PipeFillingPipeNumber-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @pipeItem.PipeNumber
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.InitialWeight" id="PipeFillingInitialWeight-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @pipeItem.InitialWeight
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.FinalWeight" id="PipeFillingFinalWeight-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @pipeItem.FinalWeight
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.DiffWeight" id="PipeFillingDiffWeight-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @pipeItem.DiffWeight Kg
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="table-responsive">
                                        <table id="table-5-analysis-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th rowspan="2" style="vertical-align: middle;">Análisis inicial</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Hora de análisis inicial de pipa</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Análisis final</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Hora de análisis final de pipa</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Analizado por</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Lote de distribución</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Fecha de caducidad</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Producto conforme</th>
                                                    <th colspan="2" style="vertical-align: middle;">
                                                        Reporte de PNC
                                                    </th>
                                                    <th rowspan="2" style="vertical-align: middle;">Dictamen liberado/rechazado</th>
                                                    <th rowspan="2" style="vertical-align: middle;">Liberado por responsable sanitario</th>
                                                </tr>
                                                <tr>
                                                    <th style="vertical-align: middle;">Folio</th>
                                                    <th style="vertical-align: middle;">Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <table id="table-5-initial-analysis-details-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered" style="margin: 0;padding: 0;width: 100%;">
                                                            <tbody>
                                                                <tr>
                                                                    @{
                                                                        int pipeItemInitialAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.InitialAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.Id" id="PipeFillingInitialAnalysisId@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            <input asp-for="@entry.ParameterName" id="PipeFillingInitialAnalysisParameterName@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.ParameterName
                                                                        </td>
                                                                        pipeItemInitialAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemInitialAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.InitialAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.MeasureUnit" id="PipeFillingInitialAnalysisMeasureUnit@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.MeasureUnit
                                                                        </td>
                                                                        pipeItemInitialAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemInitialAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.InitialAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.ValueExpected" id="PipeFillingInitialAnalysisValueExpected@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.ValueExpected.Replace(",", ".")
                                                                        </td>
                                                                        pipeItemInitialAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemInitialAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.InitialAnalysis)
                                                                    {
                                                                        <td>
                                                                            @{decimal nVal;
                                                                            decimal.TryParse(entry.ValueReal.Replace(",","."), NumberStyles.AllowDecimalPoint, CultureInfo.InvariantCulture, out nVal);
                                                                            var nValue = entry.ValueReal;

                                                                            if (entry.ParameterName.ToLower().Trim() == "identidad")
                                                                            {
                                                                                if (nVal == 1)
                                                                                    nValue = "Positiva";
                                                                                else
                                                                                    nValue = "Negativa";
                                                                            }
                                                                        }
                                                                            <input asp-for="@entry.ValueReal" id="PipeFillingInitialAnalysisValueReal@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                               @nValue.Replace(",", ".")
                                                                        </td>
                                                                        pipeItemInitialAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                @if (pipeItem.InitialAnalysis.Any(x => x.ParameterName.Contains("Identidad")) && Model.ProductName.Contains("NI"))
                                                                {
                                                                    <tr>
                                                                        @{
                                                                            pipeItemInitialAnalysisIndex = 0;
                                                                        }
                                                                        @foreach (var entry in pipeItem.InitialAnalysis)
                                                                        {
                                                                            <td>
                                                                                <input asp-for="@entry.PathFile" id="PipeFillingInitialAnalysisPath@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                                @if (entry.ParameterName.Contains("Identidad"))
                                                                                {
                                                                                    <div id="sectionInitialUploadFile@(pipeItemInitialAnalysisIndex)" style="width:220px">
                                                                                        <div class="input-group input-group-sm">
                                                                                            <input id="PipeFillingInitialAnalysisFileText@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" style="font-size:12px;" type="text" class="form-control" placeholder="Subir Archivo" readonly value="@entry.PathFile">
                                                                                            <div class="input-group-append">
                                                                                                <button id="btnuploadInitialFile@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="uploadFile('Initial', '@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex')"><i class="fa fa-upload"></i></button>
                                                                                                <button id="btnshowInitialFile@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="showFile('Initial', '@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex')" style="display:none;"><i class="fa fa-eye"></i></button>
                                                                                                <button id="btndeleteInitialFile@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="removeFile('Initial', '@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex')" style="display:none;"><i class="fa fa-trash"></i></button>
                                                                                            </div>
                                                                                        </div>
                                                                                        <input id="PipeFillingInitialAnalysisFile@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" type="file" accept="application/pdf" onchange="readFile('Initial', this, '@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex');" hidden>
                                                                                        <a id="PipeFillingInitialAnalysisAtributoLink@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" download hidden>ver archivo</a>
                                                                                        <a id="PipeFillingInitialShowLink@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" href="/ConditioningOrder/DownloadFile?path=@entry.PathFile" target="_blank" hidden></a>
                                                                                    </div>

                                                                                    <input type="hidden" id="PipeFillingInitialAnalysisAtributoValue@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" />
                                                                                }
                                                                            </td>
                                                                            pipeItemInitialAnalysisIndex++;
                                                                        }
                                                                    </tr>
                                                                }
                                                                <tr>
                                                                    @{
                                                                        pipeItemInitialAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.InitialAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.Unique" id="PipeFillingInitialAnalysisUnique@(pipeItemInitialAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />

                                                                        </td>
                                                                        pipeItemInitialAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.InitialAnalyzedDate" id="PipeFillingInitialAnalyzedDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @(pipeItem.InitialAnalyzedDate.HasValue ? ((DateTime)pipeItem.InitialAnalyzedDate).ToString("yyyy-MM-dd HH:mm") : null )
                                                    </td>
                                                    <td>
                                                        <table id="table-5-final-analysis-details-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered" style="margin: 0;padding: 0;width: 100%;">
                                                            <tbody>
                                                                <tr>
                                                                    @{
                                                                        int pipeItemFinalAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.FinalAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.Id" id="PipeFillingFinalAnalysisId@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            <input asp-for="@entry.ParameterName" id="PipeFillingFinalAnalysisParameterName@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.ParameterName
                                                                        </td>
                                                                        pipeItemFinalAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemFinalAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.FinalAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.MeasureUnit" id="PipeFillingFinalAnalysisMeasureUnit@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.MeasureUnit
                                                                        </td>
                                                                        pipeItemFinalAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemFinalAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.FinalAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.ValueExpected" id="PipeFillingFinalAnalysisValueExpected@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                            @entry.ValueExpected.Replace(",", ".")
                                                                        </td>
                                                                        pipeItemFinalAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                <tr>
                                                                    @{
                                                                        pipeItemFinalAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.FinalAnalysis)
                                                                    {
                                                                        <td>
                                                                            @{decimal nVal;
                                                                            decimal.TryParse(entry.ValueReal.Replace(",", "."), NumberStyles.AllowDecimalPoint, CultureInfo.InvariantCulture, out nVal);
                                                                            var nValue = entry.ValueReal;

                                                                                if (entry.ParameterName.ToLower().Trim() == "identidad")
                                                                                {
                                                                                    if (nVal == 1)
                                                                                        nValue = "Positiva";
                                                                                    else
                                                                                        nValue = "Negativa";
                                                                                }
                                                                            }
                                                                            <input asp-for="@entry.ValueReal" id="PipeFillingFinalAnalysisValueReal@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                             @nValue.Replace(",", ".")
                                                                        </td>
                                                                        pipeItemFinalAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                                @if (pipeItem.FinalAnalysis.Any(x => x.ParameterName.Contains("Identidad")) && Model.ProductName.Contains("NI"))
                                                                {
                                                                    <tr>
                                                                        @{
                                                                            pipeItemFinalAnalysisIndex = 0;
                                                                        }
                                                                        @foreach (var entry in pipeItem.FinalAnalysis)
                                                                        {
                                                                            <td>
                                                                                <input asp-for="@entry.PathFile" id="PipeFillingFinalAnalysisPath@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                                                @if (entry.ParameterName.Contains("Identidad"))
                                                                                {
                                                                                    <div id="sectionFinalUploadFile@(pipeItemFinalAnalysisIndex)" style="width:220px">
                                                                                        <div class="input-group input-group-sm">
                                                                                            <input id="PipeFillingFinalAnalysisFileText@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" style="font-size:12px;" type="text" class="form-control" placeholder="Subir Archivo" readonly value="@entry.PathFile">
                                                                                            <div class="input-group-append">
                                                                                                <button id="btnuploadFinalFile@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="uploadFile('Final', '@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex')"><i class="fa fa-upload"></i></button>
                                                                                                <button id="btnshowFinalFile@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="showFile('Final', '@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex')" style="display:none;"><i class="fa fa-eye"></i></button>
                                                                                                <button id="btndeleteFinalFile@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" class="btn btn-inverse-inverse" type="button" onclick="removeFile('Final', '@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex')" style="display:none;"><i class="fa fa-trash"></i></button>
                                                                                            </div>
                                                                                        </div>
                                                                                        <input id="PipeFillingFinalAnalysisFile@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" type="file" accept="application/pdf" onchange="readFile('Final', this,'@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex');" hidden>
                                                                                        <a id="PipeFillingFinalAnalysisAtributoLink@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" download hidden>ver archivo</a>
                                                                                        <a id="PipeFillingFinalShowLink@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" href="/ConditioningOrder/DownloadFile?path=@entry.PathFile" target="_blank" hidden></a>
                                                                                    </div>
                                                                                    <input type="hidden" id="PipeFillingFinalAnalysisAtributoValue@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" />
                                                                                }
                                                                            </td>
                                                                            pipeItemFinalAnalysisIndex++;
                                                                        }
                                                                    </tr>
                                                                }
                                                                <tr>
                                                                    @{
                                                                        pipeItemFinalAnalysisIndex = 0;
                                                                    }
                                                                    @foreach (var entry in pipeItem.FinalAnalysis)
                                                                    {
                                                                        <td>
                                                                            <input asp-for="@entry.Unique" id="PipeFillingFinalAnalysisUnique@(pipeItemFinalAnalysisIndex)-@tourNumberIndex-@pipeIndex" hidden />

                                                                        </td>
                                                                        pipeItemFinalAnalysisIndex++;
                                                                    }
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.FinalAnalyzedDate" id="PipeFillingFinalAnalyzedDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />

                                                        @( pipeItem.FinalAnalyzedDate.HasValue ? ((DateTime)pipeItem.FinalAnalyzedDate).ToString("yyyy-MM-dd HH:mm") : null )
                                                    </td>
                                                    <td>
                                                        @pipeItem.AnalyzedBy
                                                        <input class="form-control text-center" asp-for="@pipeItem.AnalyzedBy" id="PipeFillingAnalyzedBy-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        <input class="form-control text-center" asp-for="@pipeItem.AnalyzedDate" id="PipeFillingAnalyzedDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        <div id="PipeFillingAnalyzedSignature"></div>
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.DistributionBatch" id="PipeFillingDistributionBatch-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @pipeItem.DistributionBatch
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.DueDate" id="PipeFillingDueDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        @( pipeItem.DueDate.HasValue ? ((DateTime)pipeItem.DueDate).ToString("yyyy-MM-dd") : null )
                                                    </td>
                                                    <td>
                                                        <div class="row pl-3" style="text-align: center; width:70px;">
                                                            <input type="checkbox" id="PipeFillingInComplianceCheckTrue-@tourNumberIndex-@pipeIndex" onclick="return false;" form-control-lg />
                                                            <label class="ml-2">Sí</label>
                                                        </div>
                                                        <div class="row pl-3" style="text-align: center; width:70px;">
                                                            <input type="checkbox" id="PipeFillingInComplianceCheckFalse-@tourNumberIndex-@pipeIndex" onclick="return false;" form-control-lg />
                                                            <label class="ml-2">No</label>
                                                        </div>
                                                        <input asp-for="@pipeItem.InCompliance" id="PipeFillingInCompliance-@tourNumberIndex-@pipeIndex" hidden class="form-control" />
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.ReportPNCFolio" id="PipeFillingReportPNCFolio-@tourNumberIndex-@pipeIndex" disabled />
                                                    </td>
                                                    <td>
                                                        <input asp-for="@pipeItem.ReportPNCNotes" id="PipeFillingReportPNCNotes-@tourNumberIndex-@pipeIndex" disabled />
                                                    </td>
                                                    <td>
                                                            <div class="row pl-4" style="text-align: center; width:150px;">
                                                                <input type="checkbox" id="PipeFillingReleasedCheckTrue-@tourNumberIndex-@pipeIndex" form-control-lg />
                                                                <label class="ml-2">Liberado</label>
                                                            </div>
                                                            <div class="row pl-4" style="text-align: center; width:150px;">
                                                                <input type="checkbox" id="PipeFillingReleasedCheckFalse-@tourNumberIndex-@pipeIndex" form-control-lg />
                                                                <label class="ml-2">Rechazado</label>
                                                            </div>
                                                   
                                                        <input asp-for="@pipeItem.IsReleased" id="PipeFillingIsReleased-@tourNumberIndex-@pipeIndex" hidden class="form-control" />
                                                    </td>
                                                    <td>
                                                        <input class="form-control text-center" asp-for="@pipeItem.ReleasedBy" id="PipeFillingReleasedBy-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        <input class="form-control text-center" asp-for="@pipeItem.ReleasedDate" id="PipeFillingReleasedDate-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                        <div id="PipeFillingReleasedSignature-@tourNumberIndex-@pipeIndex"></div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="table-responsive">
                                        <table id="table-5-customers-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>No. de tanque de cliente</th>
                                                    <th>Nombre del cliente</th>
                                                    <th>No. de entrega de órden</th>
                                                    <th>Generación y firma del certificado de análisis por el responsable sanitario</th>
                                                    <th>Certificado de análisis COC-4</th>
                                                    <th>Enviar por correo electrónico el certificado de análisis COC-4</th>
                                                    <th>Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int customersIndex = 0;
                                                }
                                                @foreach (var entry in pipeItem.Customers)
                                                {
                                                    <tr>
                                                        @{
                                                            string style = "";
                                                        }
                                                        @if (@entry.state.HasValue && @entry.state == true)
                                                        {
                                                            style = "";
                                                        }
                                                        else if (@entry.state.HasValue && @entry.state == false)
                                                        {
                                                            style = "pointer-events: none";
                                                        }
                                                        <td>
                                                            @if (@entry.state.HasValue && @entry.state == true)
                                                            {
                                                                <span class="d-inline-block" id="PipeFillingToolId@(customersIndex)-@tourNumberIndex-@pipeIndex" tabindex="0" data-toggle="tooltip" title="se añade por enrutamiento">
                                                                    <img src="~/img/waygreen.png" id="PipeFillingImg@(customersIndex)-@tourNumberIndex-@pipeIndex" width="40px" />
                                                                </span>

                                                            }
                                                            else if (@entry.state.HasValue && @entry.state == false)
                                                            {
                                                                <span class="d-inline-block" id="PipeFillingToolId@(customersIndex)-@tourNumberIndex-@pipeIndex" tabindex="0" data-toggle="tooltip" title="se re-enruta el cliente">
                                                                    <img src="~/img/wayred.png" id="PipeFillingImg@(customersIndex)-@tourNumberIndex-@pipeIndex" width="40px" />
                                                                </span>
                                                            }
                                                        </td>
                                                        <td>
                                                            <input asp-for="@entry.Id" id="PipeFillingCustomerId@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden />
                                                            <input asp-for="@entry.Tank" id="PipeFillingCustomerTank@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            <input asp-for="@entry.state" id="PipeFillingCustomerState@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            @entry.Tank
                                                        </td>
                                                        <td>
                                                            <input asp-for="@entry.Name" id="PipeFillingCustomerName@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            @entry.Name
                                                        </td>
                                                        <td>
                                                            <input asp-for="@entry.DeliveryNumber" id="PipeFillingCustomerDeliveryNumber@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            @entry.DeliveryNumber
                                                        </td>
                                                        <td>
                                                            @if (string.IsNullOrEmpty(entry.ReviewedBy) || !entry.ReviewedDate.HasValue)
                                                            {
                                                                @if (rolesUsr.Contains(SecurityConstants.PERFIL_RESPONSABLE_SANITARIO))
                                                                {
                                                                    <button id="btnPipeFillingCustomerReviewedSignature@(customersIndex)-@tourNumberIndex-@pipeIndex" type="button" class="btn btn-success sign-pipe-customer" onclick="signPipeFillingCustomerRecord(@(customersIndex), @tourNumberIndex, @pipeIndex, '@entry.Name','@item.TourNumber', '@pipeItem.PipeNumber', '@pipeItem.DistributionBatch', '@entry.Tank')" style="@style">Firma del Responsable Sanitario</button>
                                                                }
                                                            }
                                                            <input asp-for="@entry.ReviewedBy" id="PipeFillingCustomerReviewedBy@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            <input asp-for="@entry.ReviewedDate" id="PipeFillingCustomerReviewedDate@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />
                                                            <div id="PipeFillingCustomerReviewedSignature@(customersIndex)-@tourNumberIndex-@pipeIndex"></div>
                                                            <span id="spanSignature@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden>NA</span>
                                                        </td>
                                                        <td>
                                                            <input asp-for="@entry.AnalysisReport" id="PipeFillingCustomerAnalysisReport@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden="hidden" />

                                                            @if (!string.IsNullOrEmpty(entry.AnalysisReport) && entry.ReviewedDate.HasValue)
                                                            {

                                                                <a href="/ConditioningOrder/ExportCertificateToPDF?IdOP=@Model.ProductionOrderId&Id=@Model.Id&tourNumber=@item.TourNumber&pipeNumber=@pipeItem.PipeNumber&tank=@entry.Tank&distributionBatch=@pipeItem.DistributionBatch"
                                                                   class="btn btn-white m-r-5" type="button" style="background-color: transparent;">

                                                                    <label id="PipeFillingCustomerAnalysisReportLbl@(customersIndex)-@tourNumberIndex-@pipeIndex">
                                                                        @entry.AnalysisReport
                                                                    </label>
                                                                </a>
                                                            }
                                                            <span id="spanReport@(customersIndex)-@tourNumberIndex-@pipeIndex" hidden>NA</span>
                                                            <div id="PipeFillingCustomerAnalysisReportDiv@(customersIndex)-@tourNumberIndex-@pipeIndex"></div>
                                                        </td>
                                                        <td>
                                                            <div class="row" style="display: block;width:500px!important; @style">
                                                                <input asp-for="@entry.EmailsList" id="PipeFillingCustomerEmailsList@(customersIndex)-@tourNumberIndex-@pipeIndex" data-role="tagsinput" style="margin: 50px;" />
                                                            </div>
                                                            <button id="btnPipeFillingSendEmail@(customersIndex)-@tourNumberIndex-@pipeIndex" type="button" style="margin: 20px auto; @style" class="btn btn-success sign-pipe-customer" onclick="SendStringsEmails(@(customersIndex), @tourNumberIndex, @pipeIndex,'@pipeItem.TourNumber', '@entry.Tank', '@pipeItem.DistributionBatch')" hidden>Envíar notificación</button>
                                                            <img id="imgLoadingPipeFillingSendEmail@(customersIndex)-@tourNumberIndex-@pipeIndex" src="~/img/spinning-loading.gif" style="padding-left:10px;display: none; width:50px;" />
                                                            <span id="checkIcon@(customersIndex)-@tourNumberIndex-@pipeIndex">
                                                                @if (entry.EmailsListSend.HasValue && entry.EmailsListSend.Value)
                                                                {
                                                                    <i class="fa fa-check" style="color:green"></i>
                                                                }
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <input asp-for="@entry.Notes" id="PipeFillingCustomerNotes@(customersIndex)-@tourNumberIndex-@pipeIndex" style="@style" />
                                                        </td>
                                                    </tr>
                                                    customersIndex++;
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <button class="btn btn btn-inverse" type="button" onclick="uploadCustomerFiles('@pipeItem.TourNumber', '@pipeItem.DistributionBatch','@pipeItem.PipeNumber', '@tourNumberIndex', '@pipeIndex')" style="margin-top:10px;margin-bottom:10px;">
                                        <i class="fa fa-save"></i> Subir archivo
                                    </button>
                                    <div class="table-responsive">
                                        <table id="table-5-customers-Upload-@tourNumberIndex-@pipeIndex" class="table table-striped table-bordered" height="40px">
                                            <thead>
                                                <tr>
                                                    <th>Nombre del cliente</th>
                                                    <th>Eliminación</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                   int customersUploadIndex = 0;
                                                }
                                                @if (pipeItem.CustomersFiles != null)
                                                {
                                                    @foreach (var entry in pipeItem.CustomersFiles)
                                                    {
                                                        <tr id="CustomersFilesId-@(customersUploadIndex)-@tourNumberIndex-@pipeIndex">
                                                            <td>
                                                                <a href="/ConditioningOrder/DownloadFileCustomer?FileName=@entry.FileName" target="_blank">@entry.FileNameOrigin</a>
                                                            <td>
                                                                @if (@entry.state.HasValue && @entry.state == true)
                                                                {
                                                                    <label onclick="DeleteCustomerFiles(@customersUploadIndex,@tourNumberIndex,@pipeIndex, @entry.TourNumber, '@entry.DistributionBatch', '@entry.PipeNumber','@entry.FileName')" class="fa fa-window-close" id="LblActive-@(customersUploadIndex)-@tourNumberIndex-@pipeIndex">Eliminar</label>
                                                                    <br />
                                                                }
                                                                else if (@entry.state.HasValue && @entry.state == false)
                                                                {
                                                                   <label id="LblDefuse@(customersUploadIndex)-@tourNumberIndex-@pipeIndex">Eliminado</label>
                                                                }
                                                            </td>
                                                        </tr>
                                                        customersUploadIndex++;
                                                    }
                                                }  
                  
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            pipeIndex++;
                        }
                    </div>
                </div>
            </div>
            tourNumberIndex++;
        }
    </div>
</div>

<script src="~/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js"></script>
<link href="~/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css" rel="stylesheet" />